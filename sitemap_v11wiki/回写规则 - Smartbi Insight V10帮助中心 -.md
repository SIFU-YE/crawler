
## 概述
我们通过回写规则设置电子表格和回写表的关联关系，实现电子表格的数据写入到回写表中。
## 功能入口
点击工具栏的 **回写规则** 按钮，如图：
## 界面介绍
“回写规则设置”界面如图：
各设置项说明如下：
回写规则管理 | 新增规则 |  点击 **新增规则（** 一个电子表格可以添加多个回写规则，并且可以指定不同的回写规则选择不同的数据库和数据表。  
---|---|---  
复制规则 |  点击 按钮，复制选中的规则，如图，选中“新规则1”，复制的规则为“新规则1-副本”：  
删除规则 | 点击 按钮，删除选中的规则。  
上移 | 点击 按钮，向上移动选中的规则。  
下移 |  点击 按钮，向下移动选中的规则。  
设置此回写规则的名称。  
勾选禁用表示禁用此回写规则。  
选择回写库和回写表 |  选择用于存储当前报表数据的目标数据库。 目前hbase、impala、sparksql、hive这4种数据库类型不支持回写。  
表 | 选择用于存储当前报表数据的目标数据表。  
主键 |  主键实质上就是标志位或称为条件，依据这个条件更新或插入新数据。 设置回写规则时必须添加主键。 1）设置取消主键方式一： 双击主键列对应的单元格，进行设置/取消主键。 2）选中列，在主键列对应的单元格右键菜单中，选择 **设置主键/取消主键** ，如图： 设置为“主键（自增）”的字段，表示该字段的数据在回写时不进行操作，当保存数据时，主键字段会自行+1保存。 主键自增需要在数据库中对应的字段也设置主键自增，当主键为自增时，只能通过右键菜单设置主键。  
列 |  指回写表中需关联的字段。 点击 按钮，下拉列表列出回写表里的所有字段，如图：  
类型指获取电子表格数据的类型，包括“单元格、参数、值”三种。 值指依据类型的变化而变化，将单元格数据或参数数据或值写入到对应列字段。
  * 类型为“单元格”“值”设置的方式方式一：双击“值”对应格子，输入其对应的单元格行列号。方式二：选择列，点击 **定位** 按钮，定位单元格。 
  * 类型为“参数”在“值”中选择当前电子表格包含的参数。 
  * 类型为“值”在“值”中输入需要写入到对应字段中的内容。 

  
所有列 | 点击 **所有列** 按钮，将回写表中所有字段添加进来，然后根据需要修改类型和值。  
增加 | 点击 **增加** 按钮，依次添加回写表中的字段。  
删除 |  删除选中的字段。
  * 方式一：点击 **删除** 按钮，删除选中的字段。
  * 方式二：选中字段，这右键菜单选择 **删除** ，如图： 

  
清空 |  清除所有字段。
  * 方式一：点击 **清空** 按钮，清除所有字段。
  * 方式二：选中字段，在右键菜单选择 **清空** ，如图：

  
定位 | 当类型为“单元格”时，“值”可通过点击 **定位** 按钮，定位单元格。  
单元格统一调整 |  对类型为“单元格”时，点击 单元格统一调整 按钮，弹出“单元格偏移”窗口，对“值”的单元格行列号进行统一调整。  
回写方式设置 | 回写内容 |  回写内容分为“回写修改内容”和“回写所有内容”。
  * 回写修改内容：回写规则所对应的回写表中，只有当回写表中的数据发生了修改，修改的数据才回写到数据表中。一般适用于回写表和电子表格数据表是不同的。
  * 回写所有内容：不管数据是否修改，所有数据都会回写到数据表中。一般适用于回写表和电子表格数据表是相同的。

  
更新和插入 |  更新和插入分为“执行更新和插入”、“只执行更新”、“只执行插入”和“强制先执行更新再执行插入”。
  * 执行更新和插入：更新和插入数据。
  * 只执行更新：只更新数据。
  * 只执行插入：只插入新数据。
  * 强制先执行更新再执行插入：先更新数据再插入数据。

“强制先执行更新再执行插入”的使用方法： 当电子表格的数据来源表和回写表不是同一个表，但是主键相同，回写设置必须勾选”强制先执行更新再执行插入”设置项，才能保证回写成功。其处理逻辑为：回写时会根据设置的主键，作为Where条件去执行一次更新，将主键相同的数据更新完毕后，如果有数据要进行插入的再执行插入。 示例1：在回写报表使用Excel批量导入数据时，勾选“执行更新和插入”，如果报表中使用了数据集并在Web端回写修改了报表内容时，执行更新数据操作，其他情况执行插入数据操作。 示例2：在回写报表使用Excel批量导入数据时，遇到主键相同的情况，需要先勾选“强制执行更新再执行插入”，然后更新数据。  
批量导入 |  设置列表式回写报表是否支持使用Excel批量导入数据。 勾选后查看报表，在工具栏中点击 **批量导入** 按钮，上传文件导入数据。 批量回写示例请参见：电子表格-批量回写。 注意事项：
  * 只支持后缀为.xlsx的Excel文件导入；
  * 导入的文件需要和报表的sheet页名称一致、个数相同、列字段相同；
  * 只有设置了填报属性的单元格才能导入数据；
  * 时间字段格式：与数据库日期格式匹配或设置为“YYYY-MM-DD HH:MM:SS”格式；
  * 报表的左父格全部为默认，不支持自定义父格的报表导入数据。

  
