
# **1 概述**
用户可以通过编写SQL语句对数据中的表进行加工、处理再添加到数据模型中。
前置条件
1、SQL查询支持直连、抽取模式。
2、如果SQL查询里的SQL语句在模型里是作为一个子查询使用，如果原业务库不支持嵌套SQL，则需要修改SQL语句或者切换为抽取模式. 
3、如果SQL查询定义了参数，可参考参数设置进行参数映射！
4、目前SQL查询编辑器仅支持执行一条SQL语句！通过"分号(;)"可以进行多条SQL语句的执行，最后一个必须是select语句（说明：SQL查询会以分号分隔，将这些复杂SQL当作多条SQL执行，不支持存储过程、代码块等相关写法），可能会影响保存、预览数据。
5、SQL查询如果嵌套后，可能会导致字段的数据类型识别不准确，如果不准确，可通过CONVERT函数转换规避。
6、数据模型的SQL查询中的参数，不支持备选值中包含逗号，如果备选值包含逗号是会自动分割，以多个值进行查询。
# 
1 | 执行 |  执行：执行全部SQL 执行选中SQL语句：支持用户选中界面上的部分SQL运行  
---|---|---  
2 | 保存 | 保存SQL查询  
3 | 格式化SQL | 对SQL进行格式化  
4 | 复制SQL | 复制SQL语句到粘贴板  
5 | 回到模型 | 返回到数据模型主页  
数据源业务视图下创建的SQL查询与数据模型创建的SQL查询，不能使用参数；并且
# 
## **3. 1 通过参数过滤数据**
我们都知道，金融、制造等行业的数据量比较大，业务用户在分析报表的时候如果把全部的数据都拉下来，会非常耗时，所以在很多场景下，只希望拉取某天或某几天的数据的数据。
以产品自带数据源northwind数据库下的“orders”表为例，由于每天的订单数据很大，需要增加时间过滤进行查询。
具体的操作步骤如下：
1、创建数据模型并在模型中增加 “SQL查询”，在SQL查询下面编写带有条件的SQL语句，如下图：
  * where {[字段=${ParamName}]}参数是动态值，"{[]}"代表参数默认值可不填写，不填写代表查询全部数据。
  * 如果 where 字段=${ParamName}，这种写法也支持，但是参数默认值必填，否则执行不通过。
  * 如果在模型中的[参数管理]进行了关联映射，可以随着模型设置的默认值改变输出结果集；具体可参考：参数设置。
  * 参数数据类型，默认是字符串，用户可以选择与SQL查询条件字段匹配的数据类型：日期、日期时间、时间、整型、浮点型、长浮点型、其他。


2、如果用户写好了SQL查询，想回到数据模型，建议先点击 **保存** 之后再点击 **回到模型** ；可以在模型修改
## **3.2 通过参数控制权限**
业务用户开发了“销售报表”，老板(admin)可以查看全部地区的销售数据，但是各地区的负责人只能查看对应地区的数据。
目前用户”A“是华南地区的负责人，那如何做到用户”A“只能查看”华南“地区的数据？
我们以产品自带数据源northwind数据库下的“orders”为例：“orders” 存储的是各个区域、省份、城市的销售订单信息。
具体的操作步骤如下：
1、创建数据模型并在模型中增加 **SQL查询 ,** 用户通过SQL查询控制权限:
  * 如果权限比较简单，比如通过”用户所属组”可以直接匹配的，可直接用 进行控制；上图的CurrentUserDefaultDepartmentAlias就是用户所属组与区域匹配上了，所以可以控制权限。
  * 如果权限控制比较复杂，比如用户存储在另外一个业务库，需要通过SQL语句进行再处理的，可使用 。


2、保存并回到模型，查看最终效果(预览模型)：如需要把该参数在报表层应用，可以参考：参数设置进行映射。
## **3.3 通过SQL实现数据加工、多表关联等生成宽表**
有时候IT技术人员是直接通过SQL处理、加工好对应的指标，然后让业务人员直接基于处理好的指标进行报表展现，并且查询全部数据，这时候也可以使用模型里面的SQL查询。
我们以查看“产品销售额”为例来进行说明。
1、**创建数据模型** 并在模型中增加 **SQL查询**
2、以产品自带northwind数据库下的”product“、“orderdetails” 为例编写SQL语句如下图：
  * 可以在SQL语句中多表关联、过滤、使用数据库本身的函数进行计算、字符串替换、拼接、case when等等。


3、**保存** 之后再回到 回到模型，以查询名称命名生成了一个宽表，选中 **查询** 通过 **右键菜单** 可以设置与其他查询的关系或者参考构建数据模型构建自己的模型。
## **3.4 通过SQL进行union**
前置条件
如果想复现示例，需要先把示例数据导入到模型中，详细请参考：导入文件数据。
某软件公司北京、广州、深圳的合同数据分别存在三张表中，老板想看三个城市的报表，业务用户希望能把他们进行合并。
目前可以通过数据模型的SQL查询：写SQL语句union2个或多个不同的表。
使用 union 将数据合并到一起,如下图:
  * 合并前是各个查询单独查询数据，合并之后，3张表的数据全部合成一张表；查看总数，已经累加了三张表的数据。
  * **union** ：用于合并俩个或多个SELECT语句的结果集，并且消去表中任何重复行,纵向追加数据。
  * 也可以使用**union all，union all** 与union的区别是：union all 不会消除表中重复行。
  * **保存** 之后再回到 **回到模型** ，可以设置与其他查询的关系或者参考构建数据模型构建自己的模型。

  
