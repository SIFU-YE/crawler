
# **1 概述**
存储过程（Stored Procedure）是在大型数据库系统中，一组为了完成特定功能的SQL 语句集，它存储在数据库中，一次编译后永久有效，用户通过指定存储过程的名字并给出参数（如果该存储过程带有参数）来执行它。存储过程是数据库中的一个重要对象, 在数据量特别庞大的情况下利用存储过程能达到倍速的效率提升。
前置条件
1、常用数据库：mySQL、SQL Server、Oracel、DB2等其他数据库 2、支持的数据库请查阅：支持的数据源范围【内部】 | 要求连接用户必须具有访问DBC.TABLES、DBC.COLUMNS的权限，及调用Exec方法的权限。  
---|---  
指定数据库：Teradata | 要求连接用户必须具有调用getProcedureColumns和Call方法的权限。  
1、如果模型原先是直连模式，增加了存储过程查询，会强制变成抽取模式;详情可查阅: 直连&抽取
2、如果存储过程有参数，可参考参数设置进行参数映射
# **2 存储过程取数**
以产品自带northwind数据库自带的 ”根据产品类别ID获取产品信息“ 存储过程 **northwind.sp_getProductInfow** 为示例进行说明。
## **2.1 前提条件**
1、需要先在Smartbi系统中的 **数据连接** 中的 **数据库管理** ，选择所需的存储过程资源，具体操作可查看：数据库管理。
2、对所选存储过程进行管理,“存储过程管理”窗口中通过**自动检测****检测结果集**
3、点击 **确定** 在资源树上会看到存储过程的结果集： 
## **2.2 具体操作**
1、创建数据模型，并添加“存储过程查询”：
  * 选择结果集，如果没有出现结果集，请检查是否 做了 **2.1章节** 内容**。**
  * 参数默认值：把存储过程结果集，拖拽到到编辑器，会自动检测是否定义了参数、以及参数默认值是否必填； 如果参数默认值是必填的，必须填写参数默认值才能执行成功 以及 **预览数据** 。示例的参数默认值是必填的，给默认值填写”1“，能正常查出数据。


2、如果要想 回到模型，建议先 **保存** 再回到模型； 保存之后可以在关系视图中选中该 **查询、右键菜单** 做更多操作，详细查看：设置及修改查询，或者构建数据模型。
3、如果在模型中没有映射参数，会一直以默认值的结果集输出数据；如果在模型中的 参数设置 进行了关联映射，可以随着模型设置的默认值改变输出结果集；具体可参考：参数管理。
1、**存储过程** 的输出参数只支持游标类型，并且只支持一个变量对象作为输出参数。
2、注意：是 **Oracle数据库下的存储过程** ：是通过输出参数作为结果集返回。
# **3 补充说明**
下面的说明只是让技术人员了解不同类型的数据库的调用方法和检测结果集！
## **3.1 检测参数的调用方法**  
1、常用数据库：mySQL、SQL Server、Oracel、DB2等其他数据库 2、支持的数据库请查阅：支持的数据源范围【内部】 | 调用JDBC中的标准方法： connection.getMetaData().getProcedureColumns(...)。  
指定数据库：Teradata |  Teradata JDBC接口没有直接提供获取宏参数和字段的方法，所以是通过执行以下SQL语句数据集获得参数的： SELECT C.* FROM DBC.TABLES T, DBC.COLUMNS CWHERE T.DATABASENAME=? AND T.TABLENAME=? AND T.TABLEKIND='M' AND T.DATABASENAME=C.DATABASENAME AND T.TABLENAME=C.TABLENAME  
## **3.2 检测结果集的调用方法**
1、检测结果集：在前端弹出界面让用户输入参数后，真正的执行一次存储过程而获得输出字段  
1、常用数据库：mySQL、SQL Server、Oracel、DB2等其他数据库 2、支持的数据库请查阅：支持的数据源范围【内部】 | 调用JDBC中的标准方法：connection.prepareCall("{Call procName(?,?)}")  
指定数据库：Teradata | 调用下面语句执行宏：connection.prepareStatement("{Exec macroName(?,?)}")  
